const { Client, GatewayIntentBits } = require('discord.js');
const { joinVoiceChannel, createAudioPlayer, createAudioResource, AudioPlayerStatus } = require('@discordjs/voice');
const path = require('path');
const axios = require('axios');
const { ApplicationCommandOptionType } = require('discord.js');


const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.GuildVoiceStates] });

const audioFilePaths = [
  path.join(__dirname, 'media', 'quack.mp3'),
  path.join(__dirname, 'media', 'vineboom.mp3'),
  // ... more audio file paths
];const token = 'MTE4MjA0NzEyMjkzMDAyMDM1Mg.Gr5Ox7.pTe6jCsoda9J6XLVV0zxls8CWtZeu_NZJaJ_iU'; // Replace with your bot's token
const guildId = '1178045228570124368'; // Replace with your guild ID
const channelName = 'wiwi'; // Replace with your channel name

// Questions to be asked each day
const questions = [
  'What is your favorite programming language?',
  'If you could have any superpower, what would it be?',
  'What is your favorite Minecraft block?',
  'What book has influenced you the most?',
  'If you could live in any historical period, when would it be?',
  'What\'s the most beautiful place you\'ve ever seen?',
  'What\'s your favorite childhood memory?',
  'If you could learn one new skill instantly, what would it be?',
  'Who in your life has inspired you the most?',
  'What\'s your favorite movie of all time?',
  'If you could have dinner with any person, living or dead, who would it be?',
  'What\'s the best piece of advice you\'ve ever received?',
  'What\'s your dream vacation destination?',
  'If you could only eat one food for the rest of your life, what would it be?',
  'What\'s your favorite hobby or pastime?',
  'What\'s one thing you\'ve always wanted to try but never have?',
  'If you could switch lives with one person for a day, who would it be?',
  'What\'s the most interesting thing you\'ve learned recently?',
  'If you could witness any event in history, what would it be?',
  'What\'s your biggest fear?',
  'What song always makes you happy when you hear it?',
  'What would you do if you won the lottery?',
  'What\'s your favorite animal and why?',
  'What are three words you\'d use to describe yourself?',
  'What\'s a talent you wish you had?',
  'If you could meet any fictional character, who would it be?',
  'What\'s your favorite season and why?',
  'What\'s your favorite sport to watch or play?',
  'What\'s a country you\'d love to visit?',
  'If you could change one thing about the world, what would it be?',
  'What\'s your favorite quote or saying?',
  'What\'s the best meal you\'ve ever eaten?',
  'What\'s your idea of a perfect day?',
  'What\'s a subject you wish you knew more about?',
  'What\'s your favorite way to relax after a long day?',
  'What\'s the most interesting documentary you\'ve ever watched?',
  'What\'s your favorite childhood TV show?',
  'If you could have any job for a day, what would it be?',
  'What\'s the most valuable lesson you\'ve learned in life?',
  'If you could learn any language fluently, what would it be?',

  // Add more questions as needed
];

// Fun facts to be shared
const funFacts = [
  'Bananas are berries, but strawberries aren\'t.',
  'A group of flamingos is called a "flamboyance."',
  'Cows have best friends.',
  'Octopuses have three hearts.',
  'Honey never spoils.',
  'The Eiffel Tower can be 15 cm taller during the summer.',
  'Venus rotates in the opposite direction to most planets.',
  'The total weight of ants on earth once equaled the total weight of people.',
  'Some cats are allergic to humans.',
  'A group of crows is called a "murder."',
  'The heart of a shrimp is located in its head.',
  'The fingerprints of a koala are so indistinguishable from humans that they have on occasion been confused at a crime scene.',
  'Snails can sleep for three years.',
  'The "Twitter" bird actually has a name "Larry".',
  'Dolphins have names for each other.',
  'It rains diamonds on Saturn and Jupiter.',
  'Adult cats only meow at humans, not other cats.',
  'Kangaroos can\'t walk backwards.',
  'Peanuts are not nuts; they are legumes.',
  'A single strand of spaghetti is called a "spaghetto."',
  'The unicorn is the national animal of Scotland.',
  'The hashtag symbol is technically called an "octothorpe."',
  'Alaska is the only state that can be typed on one row of a QWERTY keyboard.',
  'A "jiffy" is an actual unit of time for 1/100th of a second.',
  'A "butt load" is a real unit of measurement, equivalent to 126 gallons.',
  'A group of owls is called a "parliament."',
  'Banging your head against a wall for one hour burns 150 calories.',
  'In Switzerland, it is illegal to own just one guinea pig.',
  'Pigeons can tell the difference between a painting by Monet and Picasso.',
  'Chewing gum while cutting onions can help prevent tears.',
  'The inventor of the frisbee was turned into a frisbee after he died.',
  'During your lifetime, you will produce enough saliva to fill two swimming pools.',
  'If you lift a kangaroo\'s tail off the ground, it cannot hop.',
  'Bananas are curved because they grow towards the sun.',
  'Billy goats urinate on their own heads to smell more attractive to females.',
  'The inventor of the Pringles can is now buried in one.',
  'In 2017, more people were killed from injuries caused by taking a selfie than by shark attacks.',
  'The top six foods that make your fart are beans, corn, bell peppers, cauliflower, cabbage, and milk.',
  'There is a species of spider called the Hobo Spider.',
  'A lion\'s roar can be heard from 5 miles away.',
  'Saint Lucia is the only country in the world named after a woman.',
  'A baby spider is called a spiderling.',
  'You cannot snore and dream at the same time.',
  'The following can be read forward and backward: Do geese see God?',
  'A baby octopus is about the size of a flea when it is born.',
  'A sheep, a duck, and a rooster were the first passengers in a hot air balloon.',
  'In Uganda, around 48% of the population is under 15 years of age.',
  'The average male gets bored of a shopping trip after 26 minutes.',
  'Recycling one glass jar saves enough energy to watch television for 3 hours.',
  'Apple and pear seeds contain arsenic, which may be deadly to dogs.',
  'Coca-Cola would be green if the food colorant wasn\'t added.',
  'In the 16th Century, Turkish women could initiate a divorce if their husbands didn\'t pour coffee for them.',
  'Recycled paper produces 73% less air pollution than if it was made from raw materials.',
  '95% of people text things they could never say in person.',
  'The internet was invented over 40 years ago, in a beer garden!',
];

  // Add more fun facts as needed

// Store recently used questions and fun facts
let recentQuestions = [];
let recentFunFacts = [];
const historySize = 30; // Number of days to remember used questions/fun facts

// Function to pick a random question
function getRandomQuestion() {
  const availableQuestions = questions.filter(q => !recentQuestions.includes(q));
  const question = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
  updateRecentItems(recentQuestions, question);
  return question;
}

// Function to pick a random fun fact
function getRandomFunFact() {
  const availableFunFacts = funFacts.filter(f => !recentFunFacts.includes(f));
  const funFact = availableFunFacts[Math.floor(Math.random() * availableFunFacts.length)];
  updateRecentItems(recentFunFacts, funFact);
  return funFact;
}

// Update the recent items list
function updateRecentItems(list, item) {
  list.push(item);
  if (list.length > historySize) {
    list.shift(); // Remove the oldest item
  }
}

// Function to pick a random question or fun fact
function getRandomQuestionOrFunFact() {
  // Randomly decide whether to fetch a question or a fun fact
  const isQuestion = Math.random() < 0.5;
  return isQuestion ? getRandomQuestion() : getRandomFunFact();
}

// Function to fetch a random cat image
async function getRandomCatImage() {
  try {
    const response = await axios.get('https://api.thecatapi.com/v1/images/search');
    const catImage = response.data[0].url;
    return catImage;
  } catch (error) {
    console.error('I CANNOT FIND MORE CATS WIWI WE HAVE A PROBLEM', error);
    return null;
  }
}

// Function to post the Question of the Day and open a thread
async function postQuestionOfTheDay() {
  try {
    const guild = await client.guilds.fetch(guildId);
    const channel = guild.channels.cache.find(ch => ch.name === channelName);

    if (!channel) {
      console.error(`Channel '${channelName}' not found in guild '${guildId}'.`);
      return;
    }

    const question = getRandomQuestion();
    const funFact = getRandomFunFact();

    console.log(`Attempting to send content to channel ${channel.id}`);

    const message = await channel.send(`🌟🥝 Question of the Day 🥝🌟\n\n${question}\n\n🌟🎉 Fun Fact 🎉🌟\n\n${funFact}`);

    // Open a thread for the question
    const thread = await message.startThread({
      name: `QOTD: ${question.substring(0, 25)}`, // Adjust the thread name as needed
      autoArchiveDuration: 1440, // Auto-archive the thread after 24 hours (adjust as needed)
    });

    console.log(`Question successfully sent in thread: "${question}" - Thread ID: ${thread.id}`);
  } catch (error) {
    console.error('I cannot think of any questions wiwi :(', error);
  }
}

// Function to join a voice channel, play random audio at random intervals, and leave after a set duration
async function joinChannelAndPlayAudio(channel, durationInSeconds, maxRandomIntervalInSeconds) {
  const connection = joinVoiceChannel({
    channelId: channel.id,
    guildId: channel.guild.id,
    adapterCreator: channel.guild.voiceAdapterCreator,
  });

  const player = createAudioPlayer();
  connection.subscribe(player);

  const playAudioRandomly = () => {
    const randomInterval = Math.random() * maxRandomIntervalInSeconds * 1000;
    setTimeout(() => {
      const randomIndex = Math.floor(Math.random() * audioFilePaths.length);
      const resource = createAudioResource(audioFilePaths[randomIndex]);
      player.play(resource);
      playAudioRandomly(); // Schedule next playback
    }, randomInterval);
  };

  playAudioRandomly();

  // Disconnect after the specified duration
  setTimeout(() => {
    connection.destroy();
  }, durationInSeconds * 1000);
}

// Event: Bot is ready
client.once('ready', async () => {
  console.log('WIWI I AM AWAKE!');

  // Fetch the application (bot) information
  const application = await client.application.fetch();

  // Fetch and delete all global commands
  try {
    const globalCommands = await application.commands.fetch();
    globalCommands.forEach(async (command) => {
      await application.commands.delete(command.id);
    });
    console.log('The global commands were yeeted, and guess what.');
  } catch (error) {
    console.error('wiwi i cannot yeet the global commands :(', error);
  }
  
  try {
    const guild = await client.guilds.fetch(guildId);
    const guildCommands = await guild.commands.fetch();
    await Promise.all(guildCommands.map(cmd => guild.commands.delete(cmd.id)));
    console.log('I also yeeted the guild commands!.');
  } catch (error) {
    console.error('I cannot yeet the guild commands wiwi :(', error);
  }


// Register slash commands
try {
  const guild = await client.guilds.fetch(guildId);

  await guild.commands.create({
    name: 'forcequestion',
    description: 'Force the Question of the Day',
  });

  await guild.commands.create({
    name: 'meow',
    description: 'Get a random cat image',
  });

  await guild.commands.create({
    name: 'funfact',
    description: 'Get a random fun fact',
  });

  await guild.commands.create({
    name: 'wiwinoises',
    description: 'wiwibirb raids your voice chat',
    options: [{
      name: 'duration',
      type: ApplicationCommandOptionType.Integer,
      description: 'Duration in seconds',
      required: true
    }],
  });
} catch (error) {
  console.error('This is chaos wiwi I\'m confusion', error);

} finally {
  console.log('and I understood the commands!.');
}
  // Schedule posting the Question of the Day every day at a specific time (e.g., 12:00 UTC) 
  setInterval(postQuestionOfTheDay, 24 * 60 * 60 * 1000); // 24 hours
});

  
// Event: Interaction (Slash Command) received
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isCommand()) return;

  // Check which command was invoked
  if (interaction.commandName === 'forcequestion') {
    // Call postQuestionOfTheDay function to handle the forcequestion command
    await postQuestionOfTheDay();
    await interaction.reply('Question of the Day posted.');
  } else if (interaction.commandName === 'meow') {
    // Send a random cat image
    const catImage = await getRandomCatImage();
    if (catImage) {
      await interaction.reply({ content: `Here's a random cat picture:\n${catImage}` });
    } else {
      await interaction.reply('Sorry, there was an error fetching the cat picture. :(');
    }
  } else if (interaction.commandName === 'funfact') {
    // Send a random fun fact
    const funFact = getRandomFunFact();
    await interaction.reply({ content: `Fun fact!:\n${funFact}` });
  }
  if (interaction.commandName === 'wiwinoises') {
    if (interaction.member.voice.channel) {
        // Retrieve the duration from the interaction options
        const duration = interaction.options.getInteger('duration');
        await joinChannelAndPlayAudio(interaction.member.voice.channel, duration, 2); // 2 is the max random interval
        await interaction.reply(`I'M COMING WIWI for ${duration} seconds.`);
    } else {
        await interaction.reply('wtf you aren\'t in a voice channel?¿?');
    }
}
});


// Log in to Discord
client.login(token);

process.on('SIGINT', () => {
    console.log('Received SIGINT. Shutting down gracefully.');
    client.destroy(); // Ensure that the client's session is gracefully closed
    process.exit(0); // Exit the process
});